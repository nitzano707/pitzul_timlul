<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>חלוקת תמלול לפי דוברים</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f9f9f9;
            color: #333;
            direction: rtl;
        }
        textarea, #result {
            width: 80%;
            margin: 10px auto;
            padding: 10px;
            font-size: 16px;
        }
        textarea {
            height: 150px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #result {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: right;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>פענוח דוברים בתמלול</h1>
    <textarea id="transcriptionInput" placeholder="הדבק כאן את טקסט התמלול"></textarea><br>
    <button onclick="processTranscription()">פענח לפי דוברים</button>
    <div id="result">תוצאה תוצג כאן</div>

    <script>
        const apiKeys = [
            "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",
            "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",
            "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"
        ];
        let apiKeyIndex = 0;

        async function processTranscription() {
            const transcriptionText = document.getElementById("transcriptionInput").value;
            if (!transcriptionText) {
                alert("אנא הדבק טקסט תמלול");
                return;
            }

            const segments = splitTextIntoSegments(transcriptionText);
            let fullResult = "";
            document.getElementById("result").textContent = "מתחיל בעיבוד התמלול...\n\n";

            for (const segment of segments) {
                const prompt = `אנא קרא את פסקת הטקסט הבאה מתוך תמלול של ראיון. אם ניתן להבין מתוך התוכן וההקשר שזהו דובר אחד, הצג את הפסקה בדיוק כפי שהיא, מילה במילה, ללא כל שינוי. אם לעומת זאת ניתן לזהות שיש שני דוברים שונים בפסקה, אנא פצל אותה כך שכל חלק יופיע בנפרד עם ריווח בין החלקים. לפני החלק הראשון כתוב 'דובר 1' ולפני החלק השני כתוב 'דובר 2'. אם בפסקה הבאה שאתה מתמלל את מבין שדובר 2 ממשיך (או דובר 1 ממשיך לדבר) – תשאיר את המשפט לפי אותו דובר מהפסקה הקודמת. בתוצאה שאתה מחזיר אל תצרף שום מילה לפני או אחרי הטקסט המפוצל.':\n\n${segment}`;
                let success = false;
                while (!success) { // לולאה שתמשיך לנסות עד שתצליח
                    try {
                        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${apiKeys[apiKeyIndex]}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                model: "llama3-70b-8192",
                                messages: [
                                    {role: "system", content: "אתה עוזר מועיל שמפצל תמלולים לדוברים שונים"},
                                    {role: "user", content: prompt }
                                ],
                                max_tokens: 1024,
                                temperature: 1
                            })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                            if (response.status === 429) { // מגבלת שימוש
                                const waitTime = extractWaitTime(errorText);
                                if (waitTime) {
                                    console.log(`ממתין ${waitTime} שניות לפני ניסיון נוסף...`);
                                    await new Promise(resolve => setTimeout(resolve, waitTime * 1000)); // המתנה לזמן הדרוש
                                } else {
                                    apiKeyIndex = (apiKeyIndex + 1) % apiKeys.length; // מעבר למפתח API הבא
                                }
                                continue; // לנסות שוב לאחר המתנה
                            }
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }

                        const data = await response.json();
                        const result = data.choices[0]?.message?.content || '';
                        fullResult += result + "\n\n"; // איחוד התוצאה הכוללת
                        document.getElementById("result").textContent = fullResult; // עדכון התוצאה על המסך
                        success = true; // סיום הלולאה כאשר הקריאה הצליחה

                    } catch (error) {
                        console.error("Error with segment:", error);
                    }
                }

                // המתנה של 2 שניות בין קריאות כדי למנוע עומס על השרת
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            document.getElementById("result").textContent = fullResult || "שגיאה בתהליך הפענוח";
        }

        // פונקציה לחילוץ זמן ההמתנה מתוך הודעת השגיאה
        function extractWaitTime(errorText) {
            const match = errorText.match(/try again in ([\d.]+)s/);
            return match ? parseFloat(match[1]) : null;
        }

        function splitTextIntoSegments(text, maxChars = 500, maxSentences = 5) {
            const segments = [];
            let currentSegment = "";
            let sentenceCount = 0;

            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];

            for (let sentence of sentences) {
                if ((currentSegment.length + sentence.length > maxChars) || sentenceCount >= maxSentences) {
                    segments.push(currentSegment.trim());
                    currentSegment = "";
                    sentenceCount = 0;
                }

                currentSegment += sentence + " ";
                sentenceCount++;
            }

            if (currentSegment.trim()) {
                segments.push(currentSegment.trim());
            }

            return segments;
        }
    </script>
</body>
</html>
